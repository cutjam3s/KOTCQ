<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KOTCQ</title>
  <style>
    :root{ --bg:#0f1724; --card:#0b1220; --accent:#7dd3fc; --muted:#94a3b8; --text:#e6eef6; }
    html,body{ height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,var(--bg),#071027); color:var(--text); }
    .wrap{ max-width:900px; margin:4vh auto; padding:24px; background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent); border-radius:12px; box-shadow:0 6px 30px rgba(2,6,23,0.6); }
    header{ display:flex; align-items:center; gap:12px; margin-bottom:16px; }
    h1{ margin:0; font-size:1.4rem; letter-spacing:0.6px; }
    p.lead{ margin:8px 0 18px; color:var(--muted); }
    .card{ background:var(--card); padding:16px; border-radius:10px; margin-bottom:12px; }
    label{ display:block; font-size:0.9rem; margin-bottom:6px; color:var(--muted); }
    input[type="text"], textarea{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); box-sizing:border-box; }
    button{ background:linear-gradient(90deg,var(--accent),#60a5fa); color:#042029; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    footer{ margin-top:18px; color:var(--muted); font-size:0.85rem; }
    .error{ color:#ffb4b4; font-size:0.9rem; margin-top:8px; }
    .hidden{ display:none; }
    pre{ white-space:pre-wrap; word-break:break-word; background:rgba(255,255,255,0.02); padding:12px; border-radius:8px; color:var(--muted); }
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <header>
      <svg width="40" height="40" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="3" width="18" height="18" rx="3" ry="3" stroke="currentColor"></rect>
        <path d="M7 12h10M7 8h10M7 16h6" stroke="currentColor"></path>
      </svg>
      <div>
        <h1>KOTCQ</h1>
        <p class="lead">KOTCQ — updated, fixed, and resilient single-file page.</p>
      </div>
    </header>

    <section class="card" aria-labelledby="what">
      <h2 id="what" style="margin:0 0 8px 0;font-size:1rem;">Quick editor</h2>
      <label for="title">Title</label>
      <input id="title" type="text" placeholder="Enter title..." />

      <label for="body" style="margin-top:10px">Body</label>
      <textarea id="body" rows="6" placeholder="Type something..."></textarea>

      <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
        <button id="saveBtn" type="button">Save (local)</button>
        <button id="clearBtn" type="button" style="background:#334155;color:var(--text)">Clear</button>
        <div id="status" style="margin-left:auto;color:var(--muted);font-size:0.9rem">No changes</div>
      </div>

      <div id="error" class="error hidden" role="alert" aria-live="assertive" aria-atomic="true"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:1rem;">Saved preview</h2>
      <pre id="preview">Nothing saved yet</pre>
      <footer>Data is stored locally in your browser and can be cleared at any time.</footer>
    </section>
  </main>

  <script>
    (function () {
      'use strict';

      // Defensive helpers
      const $ = (selector) => document.querySelector(selector);
      const qs = (sel) => Array.from(document.querySelectorAll(sel));

      const titleEl = $('#title');
      const bodyEl = $('#body');
      const saveBtn = $('#saveBtn');
      const clearBtn = $('#clearBtn');
      const statusEl = $('#status');
      const previewEl = $('#preview');
      const errorEl = $('#error');

      const STORAGE_KEY = 'kotcq:page:v1';
      let listenersAdded = false;

      function showError(msg) {
        errorEl.textContent = msg;
        errorEl.classList.remove('hidden');
        setTimeout(() => errorEl.classList.add('hidden'), 6000);
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      // Normalize data loaded from storage to avoid runtime errors
      function normalizeData(input) {
        const normalized = { title: '', body: '', updatedAt: 'unknown' };
        if (input && typeof input === 'object') {
          if (Object.prototype.hasOwnProperty.call(input, 'title')) {
            normalized.title = typeof input.title === 'string' ? input.title : String(input.title);
          }
          if (Object.prototype.hasOwnProperty.call(input, 'body')) {
            normalized.body = typeof input.body === 'string' ? input.body : String(input.body);
          }
          if (Object.prototype.hasOwnProperty.call(input, 'updatedAt')) {
            normalized.updatedAt = typeof input.updatedAt === 'string' ? input.updatedAt : String(input.updatedAt);
          }
        }
        return normalized;
      }

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            setStatus('No saved data');
            return;
          }
          const parsed = JSON.parse(raw);
          const data = normalizeData(parsed);
          if (titleEl) titleEl.value = data.title || '';
          if (bodyEl) bodyEl.value = data.body || '';
          renderPreview(data);
          setStatus('Loaded from localStorage');
        } catch (err) {
          console.error('Load error:', err);
          showError('Failed to load saved data (corrupt or inaccessible).');
        }
      }

      function save() {
        try {
          const payload = { title: titleEl.value || '', body: bodyEl.value || '', updatedAt: new Date().toISOString() };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
          renderPreview(payload);
          setStatus('Saved locally');
        } catch (err) {
          console.error('Save error:', err);
          showError('Failed to save to localStorage. Check browser settings.');
        }
      }

      function clearAll() {
        try {
          localStorage.removeItem(STORAGE_KEY);
          titleEl.value = '';
          bodyEl.value = '';
          previewEl.textContent = 'Nothing saved yet';
          setStatus('Cleared');
        } catch (err) {
          console.error('Clear error:', err);
          showError('Failed to clear data.');
        }
      }

      function renderPreview(data) {
        try {
          const t = data.title ? data.title.trim() : '(no title)';
          const b = data.body ? data.body.trim() : '(no body)';
          previewEl.textContent = `Title: ${t}\n\n${b}\n\nSaved: ${data.updatedAt || 'unknown'}`;
        } catch (err) {
          console.error('Render error:', err);
          previewEl.textContent = 'Unable to render preview';
        }
      }

      // Wire events safely
      function addListeners() {
        if (listenersAdded) return; // prevent double-binding
        listenersAdded = true;

        if (saveBtn) saveBtn.addEventListener('click', () => { save(); });
        if (clearBtn) clearBtn.addEventListener('click', () => {
          if (!confirm('Clear saved data?')) return;
          clearAll();
        });

        // auto-save gently (debounced)
        let timer = 0;
        [titleEl, bodyEl]
          .filter(Boolean)
          .forEach(el => {
            el.addEventListener('input', () => {
              setStatus('Editing…');
              clearTimeout(timer);
              timer = setTimeout(() => {
                try { save(); } catch (e) { /* already handled in save() */ }
              }, 900);
            });
          });
      }

      // Init on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => { addListeners(); load(); });
      } else {
        addListeners(); load();
      }

      // Expose for debugging in dev console if needed
      window.KOTCQ = { load, save, clearAll, STORAGE_KEY };
    })();
  </script>
</body>
</html>